FROM python:3

COPY . /Security_Vulnerability_Check_inDocker

WORKDIR /Security_Vulnerability_Check_inDocker

RUN pip3 install -r requirements.txt

RUN apt-get update && apt-get install vim -y
RUN apt update
RUN apt-get install sudo -y
RUN apt-get install net-tools -y 
RUN apt-get install sendmail -y 





## root 계정 원격 접속 제한
## [취약] 콘솔 로그인 이외의 로그인이 가능한것 제외 
RUN apt-get install -y openssh-server
RUN mkdir /var/run/sshd

#set password
RUN echo 'root:root' |chpasswd

#replace sshd_config
RUN sed -ri 's/^#?PermitRootLogin\s+.*/PermitRootLogin no/' /etc/ssh/sshd_config

RUN /etc/init.d/ssh restart

## 리눅스 계정 잠금 임계값 설정
## [취약] 계정 잠금 정책이 설정되어 있지 않아 설정 
RUN echo 'auth required /lib/security/pam_tally.so deny=5 unlock_time=120 no_magic_root \n account required /lib/security/pam_tally.so no_magic_root reset' >> /etc/pam.d/system-auth



## shadow , passwd 파일 권한 변경
RUN chmod 400 /etc/shadow
RUN chown root:root /etc/shadow
RUN chmod 400 /etc/passwd


## /etc/(x)inetd.conf  파일 권한  설정
RUN apt-get install xinetd -y 
RUN apt-get install openbsd-inetd -y
RUN chown root /etc/inetd.conf 
RUN chmod 600 /etc/inetd.conf 
RUN chown root /etc/xinetd.conf
RUN chmod 600 /etc/xinetd.conf

## /etc/(r)syslog.conf 파일 소유자 및 권한 설정
RUN apt-get install rsyslog -y 
RUN chown root /etc/rsyslog.conf
RUN chmod 644 /etc/rsyslog.conf


## host 권한 변경
RUN mount -o remount
RUN chmod 600 /etc/hosts

## ftp 비활성화
RUN apt-get install vsftpd -y
RUN userdel ftp

## cron 파일 권한 설정
RUN apt-get install cron -y
RUN chown root /etc/cron.allow
RUN chmod 640 /etc/cron.allow
RUN chown root /etc/cron.deny
RUN chmod 640 /etc/cron.deny

## echo, discard, daytime, chargen 와 같은 Dos에 취약한 서비스 비활성화
RUN echo 'service echo \n { \n disable=yes \n id = echo-stream \n type = INTERNAL \n wait = no \n socket_type = stream \n }' >> /etc/xinetd.d/echo
RUN echo 'service echo \n { \n disable=yes \n id = echo-stream \n type = INTERNAL \n wait = no \n socket_type = stream \n }' >> /etc/xinetd.d/daytime
RUN echo 'service echo \n { \n disable=yes \n id = echo-stream \n type = INTERNAL \n wait = no \n socket_type = stream \n }' >> /etc/xinetd.d/discard
RUN echo 'service echo \n { \n disable=yes \n id = echo-stream \n type = INTERNAL \n wait = no \n socket_type = stream \n }' >> /etc/xinetd.d/chargen
RUN echo 'service echo \n { \n disable=yes \n wait = yes \n socket_type = stream \n protocol = udp \n user = root \n server = /usr/sbin/in.tftpd \n server_args = -s /tftpd \n }' >> /etc/xinetd.d/tftp
RUN echo 'service echo \n { \n disable=yes \n wait = yes \n socket_type = stream \n protocol = udp \n user = root \n server = /usr/sbin/in.tftpd \n server_args = -s /tftpd \n }' >> /etc/xinetd.d/talk
RUN service xinetd restart
RUN sed -ri 's/^#?echo/#echo/' /etc/services
RUN sed -ri 's/^#?discard/#discard/' /etc/services
RUN sed -ri 's/^#?daytime/#daytime/' /etc/services
RUN sed -ri 's/^#?chargen/#chargen/' /etc/services
RUN sed -ri 's/^#?tftp/#tftp/' /etc/services
RUN sed -ri 's/^#?talk/#talk/' /etc/services

## NFS 서비스 비활성
RUN apt install nfs-kernel-server -y
RUN kill -9 `ps -ef | grep nfsd | awk '{print $2}' `



